# Socket Server Production Monitoring System\n\nThis comprehensive monitoring system provides enterprise-grade observability, health checks, and admin controls for the Socket.IO server. It's designed to handle high-traffic scenarios and provide operations teams with full visibility into system health.\n\n## Features\n\n### 🔍 Health Checks\n- **Basic Health Check**: `/api/health/socket` - Public endpoint for load balancers\n- **Detailed Health Check**: `/api/health/socket` (POST) - Admin-only detailed system status\n- **Real-time Monitoring**: Live updates every 5 seconds\n- **Circuit Breaker Status**: Database, AI Service, and Retell service health\n- **Performance Metrics**: Response time, error rate, message throughput\n\n### 📊 Performance Monitoring\n- **Response Time Tracking**: Average, p95, p99 response times\n- **Message Rate Monitoring**: Messages per minute, throughput analysis\n- **Error Rate Calculation**: Real-time error percentage tracking\n- **Memory Usage**: Heap usage, RSS, external memory tracking\n- **CPU Monitoring**: Load average, CPU usage patterns\n- **Connection Analytics**: Active, authenticated, anonymous connections\n\n### 🚨 Alert System\n- **Configurable Alerts**: Custom thresholds for all metrics\n- **Multi-level Alerting**: Info, Warning, Critical, Emergency\n- **Alert History**: Track when alerts were triggered\n- **Auto-recovery**: Alerts automatically resolve when conditions improve\n- **Integration Ready**: Supports email, Slack, webhooks, PagerDuty\n\n### 🛠️ Admin Controls\n- **Connection Management**: View, monitor, and disconnect individual connections\n- **Maintenance Mode**: Gracefully handle server maintenance\n- **Circuit Breaker Control**: Reset circuit breakers manually\n- **Rate Limiting**: Set custom rate limits per user/connection\n- **Broadcast Messaging**: Send messages to all connected clients\n- **Emergency Controls**: Force disconnect all users, emergency shutdown\n\n### 📈 Real-time Dashboard\n- **System Overview**: Server status, uptime, key metrics\n- **Connection Details**: User information, activity, error counts\n- **Performance Graphs**: Historical data visualization\n- **Alert Management**: Configure and manage alerts\n- **Command History**: Track all admin actions\n\n## Architecture\n\n`\n┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐\n│   Load Balancer │───▶│  Socket Server  │───▶│   Database      │\n│   Health Check  │    │   (Enhanced)    │    │   (Prisma)      │\n└─────────────────┘    └─────────────────┘    └─────────────────┘\n                                │\n                                ▼\n┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐\n│   Prometheus    │◀───│  Metrics API    │───▶│   Grafana       │\n│   (Metrics)     │    │   /api/metrics  │    │   (Dashboards)  │\n└─────────────────┘    └─────────────────┘    └─────────────────┘\n                                │\n                                ▼\n┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐\n│  AlertManager   │◀───│  Alert System   │───▶│   Notification  │\n│   (Routing)     │    │   (Built-in)    │    │   (Email/Slack) │\n└─────────────────┘    └─────────────────┘    └─────────────────┘\n`\n\n## Quick Start\n\n### 1. Basic Health Check\n`bash\ncurl http://localhost:3000/api/health/socket\n`\n\n### 2. Admin Dashboard\nNavigate to your admin panel and include the `SocketMonitoringDashboard` component:\n\n`tsx\nimport SocketMonitoringDashboard from '@/components/admin/SocketMonitoringDashboard';\n\nfunction AdminPage() {\n  return (\n    <div>\n      <SocketMonitoringDashboard />\n    </div>\n  );\n}\n`\n\n### 3. External Monitoring\n`bash\n# Install dependencies\ncd scripts\nnpm install\n\n# Basic monitoring\nnode monitor-socket-health.js --url https://your-domain.com\n\n# Nagios-compatible output\nnode monitor-socket-health.js --format nagios --warning 1000 --critical 5000\n\n# Prometheus metrics\nnode monitor-socket-health.js --format prometheus\n`\n\n### 4. Production Monitoring Stack\n`bash\n# Start monitoring infrastructure\ndocker-compose -f docker-compose.monitoring.yml up -d\n\n# Access dashboards\n# Grafana: http://localhost:3001 (admin/admin123)\n# Prometheus: http://localhost:9090\n# AlertManager: http://localhost:9093\n`\n\n## API Endpoints\n\n### Health Check Endpoints\n\n#### GET /api/health/socket\nPublic health check endpoint for load balancers.\n\n**Response:**\n`json\n{\n  \"status\": \"healthy\",\n  \"responseTime\": 45,\n  \"uptime\": 3600000,\n  \"details\": {\n    \"connections\": { \"total\": 150, \"authenticated\": 120 },\n    \"performance\": { \"avgResponseTime\": 245, \"errorRate\": 0.02 },\n    \"circuitBreakers\": {\n      \"database\": { \"status\": \"closed\", \"failures\": 0 },\n      \"aiService\": { \"status\": \"closed\", \"failures\": 0 }\n    }\n  }\n}\n`\n\n#### POST /api/health/socket\nAdmin-only detailed health check with comprehensive system information.\n\n**Headers:**\n`\nAuthorization: Bearer <admin-jwt-token>\n`\n\n**Response:**\n`json\n{\n  \"status\": \"healthy\",\n  \"connections\": {\n    \"summary\": { \"total\": 150, \"authenticated\": 120 },\n    \"detailed\": [/* connection details */]\n  },\n  \"metrics\": {\n    \"current\": {/* current metrics */},\n    \"history\": [/* historical data */]\n  },\n  \"admin\": {\n    \"commandHistory\": [/* recent commands */],\n    \"alertConfigs\": [/* alert configurations */]\n  }\n}\n`\n\n### Admin Control Endpoints\n\n#### GET /api/admin/socket\nGet dashboard data and system status.\n\n**Response:**\n`json\n{\n  \"success\": true,\n  \"data\": {\n    \"status\": { \"status\": \"healthy\" },\n    \"connections\": { \"total\": 150 },\n    \"performance\": { \"avgResponseTime\": 245 },\n    \"maintenance\": { \"enabled\": false }\n  }\n}\n`\n\n#### POST /api/admin/socket\nExecute admin commands.\n\n**Request:**\n`json\n{\n  \"action\": \"force_disconnect_user\",\n  \"data\": {\n    \"userId\": \"user123\",\n    \"reason\": \"Maintenance\"\n  }\n}\n`\n\n**Available Actions:**\n- `execute_command` - Execute admin command\n- `configure_alert` - Configure alert thresholds\n- `set_rate_limit` - Set custom rate limits\n- `reset_circuit_breaker` - Reset circuit breakers\n- `set_maintenance_mode` - Enable/disable maintenance\n- `force_disconnect_user` - Disconnect specific user\n- `force_disconnect_socket` - Disconnect specific socket\n- `get_connections` - Get connection details\n- `get_metrics_history` - Get historical metrics\n- `get_command_history` - Get command history\n- `get_alert_configs` - Get alert configurations\n\n## Socket Server API\n\n### Real-time Monitoring\n\n`javascript\n// Get socket server instance\nconst socketServer = getChatSocketServer();\n\n// Get health status\nconst health = socketServer.getHealthStatus();\n\n// Get dashboard data\nconst dashboard = socketServer.getDashboardData();\n\n// Get connections\nconst connections = socketServer.getConnectionsData();\n\n// Get metrics\nconst metrics = socketServer.getMetricsData();\n`\n\n### Admin Controls\n\n`javascript\n// Force disconnect user\nawait socketServer.forceDisconnectUser('user123', 'Maintenance');\n\n// Set maintenance mode\nsocketServer.setMaintenanceMode(true, 'Scheduled maintenance');\n\n// Reset circuit breaker\nsocketServer.resetCircuitBreaker('database');\n\n// Configure alert\nsocketServer.configureCustomAlert({\n  metric: 'response_time',\n  threshold: 1000,\n  comparison: 'gt',\n  duration: 300000,\n  enabled: true\n});\n`\n\n### Event Monitoring\n\n`javascript\n// Listen for events\nsocketServer.on('client_disconnect', (data) => {\n  console.log('Client disconnected:', data);\n});\n\nsocketServer.on('message_error', (data) => {\n  console.log('Message error:', data);\n});\n\nsocketServer.on('alert', (alertData) => {\n  console.log('Alert triggered:', alertData);\n});\n`\n\n## Monitoring Configuration\n\n### Alert Configuration\n\n`javascript\n// Default alerts are pre-configured\nconst defaultAlerts = [\n  {\n    metric: 'error_rate',\n    threshold: 0.1, // 10%\n    comparison: 'gt',\n    duration: 300000, // 5 minutes\n    enabled: true\n  },\n  {\n    metric: 'response_time',\n    threshold: 5000, // 5 seconds\n    comparison: 'gt',\n    duration: 300000,\n    enabled: true\n  },\n  {\n    metric: 'memory_usage',\n    threshold: 0.9, // 90%\n    comparison: 'gt',\n    duration: 300000,\n    enabled: true\n  }\n];\n`\n\n### Custom Rate Limits\n\n`javascript\n// Set custom rate limit for specific user\nsocketServer.setCustomRateLimit(\n  { userId: 'user123' },\n  100, // 100 messages\n  60000 // per minute\n);\n\n// Set custom rate limit for specific socket\nsocketServer.setCustomRateLimit(\n  { socketId: 'socket456' },\n  50, // 50 messages\n  60000 // per minute\n);\n`\n\n## Production Deployment\n\n### Docker Compose Setup\n\n1. **Configure Environment Variables:**\n`bash\n# .env\nADMIN_TOKEN=your-admin-jwt-token\nPROMETHEUS_URL=http://prometheus:9090\nGRAFANA_URL=http://grafana:3000\nALERT_EMAIL=admin@vasquezlaw.com\nSLACK_WEBHOOK=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK\n`\n\n2. **Start Monitoring Stack:**\n`bash\ndocker-compose -f docker-compose.monitoring.yml up -d\n`\n\n3. **Configure Grafana Dashboards:**\n - Import the provided dashboard JSON files\n - Configure data sources (Prometheus, Loki)\n - Set up alerts and notifications\n\n### Kubernetes Deployment\n\n`yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: socket-server\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: socket-server\n  template:\n    metadata:\n      labels:\n        app: socket-server\n    spec:\n      containers:\n      - name: socket-server\n        image: your-registry/socket-server:latest\n        ports:\n        - containerPort: 3000\n        env:\n        - name: NODE_ENV\n          value: production\n        livenessProbe:\n          httpGet:\n            path: /api/health/socket\n            port: 3000\n          initialDelaySeconds: 30\n          periodSeconds: 30\n        readinessProbe:\n          httpGet:\n            path: /api/health/socket\n            port: 3000\n          initialDelaySeconds: 5\n          periodSeconds: 5\n`\n\n### Load Balancer Configuration\n\n#### Nginx\n`nginx\nupstream socket_servers {\n    server 127.0.0.1:3000;\n    server 127.0.0.1:3001;\n    server 127.0.0.1:3002;\n}\n\nserver {\n    listen 80;\n    server_name your-domain.com;\n    \n    location / {\n        proxy_pass http://socket_servers;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n    \n    # Health check endpoint\n    location /api/health/socket {\n        proxy_pass http://socket_servers;\n        access_log off;\n    }\n}\n`\n\n#### HAProxy\n`\nbackend socket_servers\n    balance roundrobin\n    option httpchk GET /api/health/socket\n    http-check expect status 200\n    server socket1 127.0.0.1:3000 check\n    server socket2 127.0.0.1:3001 check\n    server socket3 127.0.0.1:3002 check\n`\n\n## Security Considerations\n\n### Admin Authentication\n- All admin endpoints require JWT authentication\n- Admin tokens should have `admin: true` and `role: 'ADMIN'` claims\n- Use separate admin secret for enhanced security\n\n### Rate Limiting\n- Connection rate limiting by IP address\n- Message rate limiting per connection\n- Custom rate limits for specific users/connections\n- Automatic rate limit escalation for suspicious activity\n\n### Circuit Breakers\n- Database circuit breaker prevents cascading failures\n- AI service circuit breaker with fallback responses\n- Retell service circuit breaker for voice features\n- Automatic recovery with exponential backoff\n\n### Monitoring Security\n- Sensitive data is automatically redacted from logs\n- Admin actions are logged with full audit trail\n- Health check endpoints don't expose sensitive information\n- Prometheus metrics are sanitized\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Health Check Failing:**\n `bash\n   # Check server logs\n   tail -f logs/combined.log\n   \n   # Test health endpoint directly\n   curl -v http://localhost:3000/api/health/socket\n   `\n\n2. **High Response Time:**\n `bash\n   # Check system resources\n   node monitor-socket-health.js --format json\n   \n   # Monitor real-time metrics\n   watch -n 1 'curl -s http://localhost:3000/api/health/socket | jq .responseTime'\n   `\n\n3. **Circuit Breaker Open:**\n `bash\n   # Reset circuit breaker\n   curl -X POST http://localhost:3000/api/admin/socket \\\n     -H \"Authorization: Bearer $ADMIN_TOKEN\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"action\": \"reset_circuit_breaker\", \"data\": {\"service\": \"database\"}}'\n   `\n\n4. **Memory Usage High:**\n `bash\n   # Check memory usage\n   node -e \"console.log(process.memoryUsage())\"\n   \n   # Force garbage collection (development only)\n   node --expose-gc -e \"gc(); console.log(process.memoryUsage())\"\n   `\n\n### Log Analysis\n\n`bash\n# Filter socket-related logs\ngrep \"socket\" logs/combined.log | tail -100\n\n# Check error logs\ngrep \"error\" logs/error.log | tail -50\n\n# Monitor connection stats\ngrep \"connection_stats\" logs/combined.log | tail -20\n`\n\n### Performance Tuning\n\n1. **Optimize Memory Usage:**\n - Adjust cleanup intervals\n - Tune rate limit windows\n - Configure proper garbage collection\n\n2. **Improve Response Time:**\n - Enable connection pooling\n - Optimize database queries\n - Implement caching strategies\n\n3. **Scale Horizontally:**\n - Use Redis for session storage\n - Implement sticky sessions\n - Configure proper load balancing\n\n## Support\n\nFor issues and questions:\n- Check the health check endpoints first\n- Review the monitoring dashboard\n- Analyze logs and metrics\n- Use the external monitoring script for detailed diagnostics\n\n## License\n\nThis monitoring system is part of the Vasquez Law Firm website and is proprietary software."
